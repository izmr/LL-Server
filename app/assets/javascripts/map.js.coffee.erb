# ロード完了後、GoogleMaps生成とマーカー配置
class @MyMaps
  constructor: (@params) ->
    @canvasId = @params.canvasId
    @lat      = @params.lat
    @lng      = @params.lng
    @level    = @params.level || 12
    @range    = @params.range || 0.01
    @form     = @params.form  || {}
    @map      = {}

  # 住所から緯度経度を取得 成功したらcenterを設定
  updateCenterByAddress: (address) ->
    _this = @
    geocoder = new google.maps.Geocoder()
    geocoder.geocode { address: address }, (results, status) ->
      unless status == google.maps.GeocoderStatus.OK
        return
      result = results[0]
      _this.map.setCenter(result.geometry.location)
      $(_this.form.address).val(result.formatted_address)

  # 移動時、中央のマーカーを再配置
  reloadCenter: () ->
    _this = @
    google.maps.event.addListener @map, 'center_changed', ->
      _this.removeCenterMarker()
      _this.addCenterMarker()

  # 一点の位置の周辺情報を取得
  fetchPointsAround:() ->
    @fetchPoints({
      nlat: @lat - @range,
      slat: @lat + @range,
      nlng: @lng - @range,
      slng: @lng + @range,
    })

  # 指定した範囲の緯度経度からpoint情報取得を試みる
  fetchPoints:(latlng) ->
    _this = @
    $.ajax({
      type:     "GET",
      dataType: "json",
      url:      "/api/points",
      data:     latlng,
      success: (data, status, jqXHR) ->
        _this.showLocalPointsInfo(data)
        for point, num in data
          _this.addMarker({
            lat:   point.latitude,
            lng:   point.longitude,
            title: point.pointName
          })
    })

  # 指定したidのdivにGoogleMapsを生成
  createGmap:() ->
    latlng = new google.maps.LatLng(@lat,@lng)
    opts   = {
      zoom:      @level,
      center:    latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    window.gmap = new google.maps.Map($(@canvasId)[0], opts)
    @map = window.gmap

  removeCenterMarker:() ->
    @centerMarker.setMap(null)

  # mapの中央にマーカーを配置
  addCenterMarker:() ->
    center    = window.gmap.getCenter()
    imageUrl  = 'http://www.google.com/mapfiles/gadget/arrowSmall80.png'
    image     = new google.maps.MarkerImage imageUrl
    marker = @addMarker({
      lat:   center.lat(),
      lng:   center.lng(),
      title: 'center',
      icon:  image,
    })
    $(@form.latf).attr("value", center.lat()) if @form.latf
    $(@form.lngf).attr("value", center.lng()) if @form.lngf
    @centerMarker = marker

  # GoogleMapsにマーカーを配置
  addMarker:(opt) ->
    latlng = new google.maps.LatLng(opt.lat, opt.lng)
    marker = new google.maps.Marker({
      position: latlng,
      title:    opt.title,
      icon:     opt.icon,
    })
    marker.setMap(window.gmap)
    return marker

  # 右側スペースにpointの情報を表示
  showLocalPointsInfo:(data, opt={}) ->
    for point, num in data
      toggle = $("<a>")
        .attr("class", "accordion-toggle")
        .attr("data-toggle", "collapse")
        .attr("data-parent", "#local_points_info")
        .attr("href", "#collapseOne")
        .append(point.point_name)
      heading = $("<div>")
        .attr("class", "accordion-heading")
        .append(toggle)

      body_inner = $("<div>")
        .attr("class", "accordion-inner")
        .append(point.address)
      body = $("<div>")
        .attr("class", "accordion-body collapse")
        .attr("id", "collapseOne")
        .append(body_inner)

      group = $("<div>")
        .attr("class", "accordion-group")
        .append(heading)
        .append(body)
        $("#local_points_info").append(group)
