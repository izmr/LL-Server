# ロード完了後、GoogleMaps生成とマーカー配置
$ ->
  lat = 35.6589960
  lng = 139.70380
  create_gmap({
    id:  '#map_canvas',
    lat: lat,
    lng: lng,
  })
  fetch_points({
    nlat: lat - 0.01,
    slat: lat + 0.01,
    nlng: lng - 0.01,
    slng: lng + 0.01,
  })

# 指定した範囲の緯度経度からpoint情報取得を試みる
fetch_points=(latlng) ->
  $.ajax({
    type:     "GET",
    dataType: "json",
    url:      "/api/points",
    data:     latlng,
    success: (data, status, jqXHR) ->
      for point, num in data
        add_marker({
          lat:   point.latitude,
          lng:   point.longitude,
          title: point.point_name
        })
  })

# 指定したidのdivにGoogleMapsを生成
create_gmap=(opt) ->
  latlng = new google.maps.LatLng(opt.lat,opt.lng)
  opts   = {
    zoom:      15,
    center:    latlng,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  }
  window.gmap = new google.maps.Map($(opt.id)[0], opts)

# GoogleMapsにマーカーを配置
add_marker=(opt) ->
  latlng = new google.maps.LatLng(opt.lat, opt.lng)
  marker = new google.maps.Marker({
    position: latlng,
    title:    opt.title
  })
  marker.setMap(window.gmap)
